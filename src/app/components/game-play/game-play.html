<div class="game-layout"
     (mousemove)="onMouseMove($event)"
     (mouseup)="onMouseUp()"
     (mouseleave)="onMouseUp()"
     (click)="closeJingleMenu()">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- BUZZERS D√âPLA√áABLES AUTOUR DE LA TABLE  -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @for (buzzer of buzzers(); track buzzer.id) {
    <div class="buzzer-card"
         [class.buzzer-highlighted]="isBuzzerQuestion() && !hasPlayerAnswered(buzzer.id) && gameStatus() === 'question'"
         [class.buzzer-answered]="hasPlayerAnswered(buzzer.id)"
         [class.buzzer-excluded]="excludedPlayers().includes(buzzer.id)"
         [class.buzzer-correct]="showCorrectAnswer() && isPlayerCorrect(buzzer.id)"
         [class.buzzer-incorrect]="showCorrectAnswer() && hasPlayerAnswered(buzzer.id) && !isPlayerCorrect(buzzer.id)"
         [style.left.px]="getBuzzerPosition(buzzer.id).x"
         [style.top.px]="getBuzzerPosition(buzzer.id).y"
         (mousedown)="onBuzzerMouseDown($event, buzzer.id)">

      <div class="buzzer-header">
        <span class="buzzer-icon">üéÆ</span>
        <span class="buzzer-name">{{ buzzer.name }}</span>
        <button class="jingle-menu-btn"
                (mousedown)="$event.stopPropagation()"
                (click)="toggleJingleMenu(buzzer.id, $event)"
                [class.jingle-sending]="jingleSending() === buzzer.id">
          @if (jingleSending() === buzzer.id) {
            üéµ
          } @else {
            ‚ñº
          }
        </button>
      </div>

      <!-- Menu contextuel jingles -->
      @if (openJingleMenu() === buzzer.id && jingles().length > 0) {
        <div class="jingle-dropdown" (mousedown)="$event.stopPropagation()">
          <div class="jingle-dropdown-title">üéµ Jingles</div>
          @for (jingle of jingles(); track jingle.id) {
            <button class="jingle-dropdown-item"
                    (click)="playJingle(buzzer.id, jingle.id)">
              üéµ {{ jingle.name }}
              @if (jingle.description) {
                <small aria-label="Description: {{ jingle.description }}">{{ jingle.description }}</small>
              }
            </button>
          }
        </div>
      }
      @if (openJingleMenu() === buzzer.id && jingles().length === 0) {
        <div class="jingle-dropdown" (mousedown)="$event.stopPropagation()">
          <div class="jingle-dropdown-empty">Aucun jingle configur√©</div>
        </div>
      }
      <div class="buzzer-player">{{ getPlayerName(buzzer.id) || '‚Äî' }}</div>
      <div class="buzzer-points">{{ getBuzzerScore(buzzer.id) }} pts</div>

      <!-- R√©ponse du joueur -->
      @if (hasPlayerAnswered(buzzer.id)) {
        <div class="buzzer-answer"
             [class.ans-a]="getPlayerAnswerIndex(buzzer.id) === 0"
             [class.ans-b]="getPlayerAnswerIndex(buzzer.id) === 1"
             [class.ans-c]="getPlayerAnswerIndex(buzzer.id) === 2"
             [class.ans-d]="getPlayerAnswerIndex(buzzer.id) === 3"
             [class.ans-buzz]="isBuzzerQuestion()">
          @if (isBuzzerQuestion()) {
            üî¥ Buzz
          } @else {
            {{ ['A', 'B', 'C', 'D'][getPlayerAnswerIndex(buzzer.id)] }}
          }
        </div>
        <div class="buzzer-time">
          {{ (getPlayerResponseTime(buzzer.id) / 1000) | number:'1.1-1' }}s
        </div>
      } @else if (gameStatus() === 'question') {
        <div class="buzzer-answer ans-waiting">‚è≥</div>
      }

      @if (isBuzzerQuestion() && !hasPlayerAnswered(buzzer.id) && gameStatus() === 'question' && !excludedPlayers().includes(buzzer.id)) {
        <div class="buzzer-speed-badge">‚ö° RAPIDIT√â</div>
      }
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- TABLE CENTRALE                          -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="table-area">
    <div class="table-content">

      <!-- ‚îÄ‚îÄ‚îÄ √âTAT : En attente ‚îÄ‚îÄ‚îÄ -->
      @if (gameStatus() === 'waiting') {
        <div class="table-waiting">
          <div class="waiting-icon">üìã</div>
          <h2>Question {{ questionIndex() + 1 }} / {{ totalQuestions() }}</h2>
          <p class="waiting-subtitle">{{ buzzerCount() }} joueur(s) connect√©(s)</p>
          <button class="btn-game btn-start" (click)="sendQuestion()">
            ‚ñ∂ Envoyer la question
          </button>
        </div>
      }

      <!-- ‚îÄ‚îÄ‚îÄ √âTAT : Question en cours ‚îÄ‚îÄ‚îÄ -->
      @if (gameStatus() === 'question') {
        @if (currentQuestion(); as question) {
          <!-- Timer -->
          <div class="timer-section">
            <div class="timer-bar-container">
              <div class="timer-bar-fill"
                   [class.timer-ok]="timePercentage() > 50"
                   [class.timer-warning]="timePercentage() > 20 && timePercentage() <= 50"
                   [class.timer-danger]="timePercentage() <= 20"
                   [class.timer-paused]="timerPaused"
                   [style.width.%]="timePercentage()">
              </div>
            </div>
            <div class="timer-text">
              @if (timerPaused) {
                ‚è∏Ô∏è {{ timeRemaining() }}s (pause)
              } @else {
                ‚è±Ô∏è {{ timeRemaining() }}s
              }
            </div>
          </div>

          <!-- Badges question -->
          <div class="question-badges">
            @if (question.type === 'mcq') {
              <span class="q-badge q-badge-mcq">QCM</span>
            } @else {
              <span class="q-badge q-badge-buzzer">üî¥ RAPIDIT√â</span>
            }
            @if (question.category) {
              <span class="q-badge q-badge-cat">{{ question.category }}</span>
            }
            <span class="q-badge q-badge-pts">{{ question.points }} pts</span>
            <span class="q-badge q-badge-count">üì• {{ answersReceived() }}/{{ buzzerCount() }}</span>
          </div>

          <!-- Intitul√© -->
          <div class="question-title">{{ question.text }}</div>

          <!-- ‚ïê‚ïê‚ïê QCM : Propositions avec jauges ‚ïê‚ïê‚ïê -->
          @if (question.type === 'mcq' && question.options) {
            <div class="answers-section">
              @for (answer of question.options; track $index; let i = $index) {
                <div class="answer-row"
                     [class.answer-correct]="showCorrectAnswer() && i === question.correctAnswer"
                     [class.answer-incorrect]="showCorrectAnswer() && i !== question.correctAnswer">

                  <div class="answer-label-row">
                    <span class="answer-letter"
                          [class.letter-a]="i === 0"
                          [class.letter-b]="i === 1"
                          [class.letter-c]="i === 2"
                          [class.letter-d]="i === 3"
                          [class.letter-correct]="showCorrectAnswer() && i === question.correctAnswer">
                      {{ ['A', 'B', 'C', 'D'][i] }}
                    </span>
                    <span class="answer-text">{{ answer }}</span>
                    <span class="answer-count-label">
                      @if (answerCounts()[i] > 0) {
                        {{ answerCounts()[i] }}
                        @if (answersReceived() > 0) {
                          <small>({{ (answerCounts()[i] / answersReceived() * 100) | number:'1.0-0' }}%)</small>
                        }
                      }
                    </span>
                  </div>

                  <div class="answer-gauge-container">
                    <div class="answer-gauge-fill"
                         [class.gauge-a]="i === 0 && !showCorrectAnswer()"
                         [class.gauge-b]="i === 1 && !showCorrectAnswer()"
                         [class.gauge-c]="i === 2 && !showCorrectAnswer()"
                         [class.gauge-d]="i === 3 && !showCorrectAnswer()"
                         [class.gauge-correct]="showCorrectAnswer() && i === question.correctAnswer"
                         [class.gauge-incorrect]="showCorrectAnswer() && i !== question.correctAnswer && answerCounts()[i] > 0"
                         [style.width.%]="getAnswerBarWidth(i)">
                    </div>
                  </div>

                  <!-- Noms des joueurs sous la barre -->
                  @if (answerCounts()[i] > 0) {
                    <div class="answer-players-row">
                      @for (detail of answerDetails(); track detail.buzzerID) {
                        @if (detail.answer === i) {
                          <span class="player-chip"
                                [class.chip-correct]="showCorrectAnswer() && detail.isCorrect"
                                [class.chip-incorrect]="showCorrectAnswer() && !detail.isCorrect">
                            {{ detail.playerName }}
                            @if (showCorrectAnswer()) {
                              ({{ (detail.responseTime / 1000) | number:'1.1-1' }}s)
                            }
                          </span>
                        }
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- ‚ïê‚ïê‚ïê BUZZER : Zone rapidit√© ‚ïê‚ïê‚ïê -->
          @if (question.type === 'buzzer') {
            <div class="buzzer-zone-table">
              <div class="buzzer-zone-icon">üî¥</div>
              <h3>En attente des buzzes...</h3>

              <!-- üìå R√©ponse attendue visible par le ma√Ætre du jeu -->
              @if (question.expectedAnswer) {
                <div class="expected-answer-banner">
                  <span class="expected-answer-icon">üìå</span>
                  <span class="expected-answer-label">R√©ponse attendue :</span>
                  <strong class="expected-answer-value">{{ question.expectedAnswer }}</strong>
                </div>
              }
              <div class="buzzer-zone-players">
                @for (buzzer of buzzers(); track buzzer.id) {
                  @if (excludedPlayers().includes(buzzer.id)) {
                    <span class="bz-player-tag bz-excluded">‚ùå {{ buzzer.name }}</span>
                  } @else if (hasPlayerAnswered(buzzer.id)) {
                    <span class="bz-player-tag bz-validated">‚úÖ {{ buzzer.name }}</span>
                  } @else {
                    <span class="bz-player-tag bz-active">üî¥ {{ buzzer.name }}</span>
                  }
                }
              </div>
              @if (answerDetails().length > 0) {
                <div class="buzz-validated-list">
                  <h5>R√©ponses valid√©es :</h5>
                  @for (detail of answerDetails(); track detail.buzzerID) {
                    <span class="bz-player-tag bz-validated">
                      ‚úÖ {{ detail.playerName }} (+{{ detail.points }} pts, {{ (detail.responseTime / 1000) | number:'1.1-1' }}s)
                    </span>
                  }
                </div>
              }
            </div>
          }

          @if (allAnswered()) {
            <div class="all-answered-badge">‚úÖ Tous ont r√©pondu !</div>
          }
        }
      }

      <!-- ‚îÄ‚îÄ‚îÄ √âTAT : R√©sultats ‚îÄ‚îÄ‚îÄ -->
      @if (gameStatus() === 'results') {
        @if (currentQuestion(); as question) {
          <div class="results-section">
            <h3 class="results-title">üìä R√©sultats</h3>
            <p class="results-question">{{ question.text }}</p>

            @if (question.type === 'mcq' && question.options && question.correctAnswer !== undefined) {
              <div class="correct-answer-banner">
                ‚úÖ {{ ['A', 'B', 'C', 'D'][question.correctAnswer] }}. {{ question.options[question.correctAnswer] }}
              </div>
            }
            @if (question.type === 'buzzer' && answerDetails().length === 0) {
              <div class="no-answer-banner">‚ùå Personne n'a donn√© la bonne r√©ponse</div>
            }

            @if (answerDetails().length > 0) {
              <div class="results-table-wrapper">
                <table class="results-table">
                  <thead>
                    <tr>
                      <th>Joueur</th>
                      <th>R√©ponse</th>
                      <th>R√©sultat</th>
                      <th>Temps</th>
                      <th>Points</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (detail of answerDetails(); track detail.buzzerID) {
                      <tr [class.row-correct]="detail.isCorrect" [class.row-incorrect]="!detail.isCorrect">
                        <td><strong>{{ detail.playerName }}</strong></td>
                        <td>
                          @if (question.type === 'mcq' && question.options) {
                            {{ ['A', 'B', 'C', 'D'][detail.answer] }}. {{ question.options[detail.answer] }}
                          } @else {
                            üî¥ Buzz
                          }
                        </td>
                        <td>{{ detail.isCorrect ? '‚úÖ' : '‚ùå' }}</td>
                        <td>{{ (detail.responseTime / 1000) | number:'1.1-1' }}s</td>
                        <td><strong>+{{ detail.points }}</strong></td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        }
      }

      <!-- ‚îÄ‚îÄ‚îÄ √âTAT : Classement ‚îÄ‚îÄ‚îÄ -->
      @if (gameStatus() === 'ranking') {
        <div class="ranking-section">
          <h3 class="ranking-title">üèÜ Classement</h3>
          <div class="ranking-table-wrapper">
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Joueur</th>
                  <th>Score</th>
                  <th>Bonnes r√©p.</th>
                  <th>Temps moy.</th>
                  <th>+ rapide</th>
                </tr>
              </thead>
              <tbody>
                @for (player of ranking(); track player.buzzerID; let i = $index) {
                  <tr [class.rank-gold]="i === 0" [class.rank-silver]="i === 1" [class.rank-bronze]="i === 2">
                    <td class="rank-cell">
                      @switch (i) {
                        @case (0) { ü•á }
                        @case (1) { ü•à }
                        @case (2) { ü•â }
                        @default { {{ i + 1 }} }
                      }
                    </td>
                    <td><strong>{{ player.name }}</strong></td>
                    <td><strong>{{ player.score }}</strong> pts</td>
                    <td>
                      {{ player.correctAnswers }}/{{ player.totalAnswers }}
                      @if (player.totalAnswers > 0) {
                        <small>({{ (player.correctAnswers / player.totalAnswers * 100) | number:'1.0-0' }}%)</small>
                      }
                    </td>
                    <td>
                      @if (player.avgResponseTime > 0) {
                        {{ (player.avgResponseTime / 1000) | number:'1.1-1' }}s
                      } @else { ‚Äî }
                    </td>
                    <td>
                      @if (player.fastestResponseTime > 0) {
                        {{ (player.fastestResponseTime / 1000) | number:'1.1-1' }}s
                      } @else { ‚Äî }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }

      <!-- ‚îÄ‚îÄ‚îÄ √âTAT : Partie termin√©e ‚îÄ‚îÄ‚îÄ -->
      @if (gameStatus() === 'ended') {
        <div class="ended-section">
          <h2 class="ended-title">üéâ Partie termin√©e !</h2>
          <div class="ranking-table-wrapper">
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Joueur</th>
                  <th>Score</th>
                  <th>Bonnes r√©p.</th>
                  <th>Temps moy.</th>
                  <th>+ rapide</th>
                  <th>+ lent</th>
                </tr>
              </thead>
              <tbody>
                @for (player of ranking(); track player.buzzerID; let i = $index) {
                  <tr [class.rank-gold]="i === 0" [class.rank-silver]="i === 1" [class.rank-bronze]="i === 2">
                    <td class="rank-cell">
                      @switch (i) {
                        @case (0) { ü•á }
                        @case (1) { ü•à }
                        @case (2) { ü•â }
                        @default { {{ i + 1 }} }
                      }
                    </td>
                    <td><strong>{{ player.name }}</strong></td>
                    <td><strong>{{ player.score }}</strong> pts</td>
                    <td>
                      {{ player.correctAnswers }}/{{ player.totalAnswers }}
                      @if (player.totalAnswers > 0) {
                        <small>({{ (player.correctAnswers / player.totalAnswers * 100) | number:'1.0-0' }}%)</small>
                      }
                    </td>
                    <td>
                      @if (player.avgResponseTime > 0) {
                        {{ (player.avgResponseTime / 1000) | number:'1.1-1' }}s
                      } @else { ‚Äî }
                    </td>
                    <td>
                      @if (player.fastestResponseTime > 0) {
                        {{ (player.fastestResponseTime / 1000) | number:'1.1-1' }}s
                      } @else { ‚Äî }
                    </td>
                    <td>
                      @if (player.slowestResponseTime > 0) {
                        {{ (player.slowestResponseTime / 1000) | number:'1.1-1' }}s
                      } @else { ‚Äî }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- BARRE DE CONTR√îLE EN BAS               -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="controls-bar">
    <div class="controls-left">
      <span class="controls-info">
        üéÆ Question {{ questionIndex() + 1 }}/{{ totalQuestions() }}
        &nbsp;¬∑&nbsp;
        üéØ {{ buzzerCount() }} joueurs
      </span>
    </div>
    <div class="controls-center">
      @if (gameStatus() === 'question') {
        <button class="btn-ctrl btn-ctrl-warning" (click)="showResults()">
          ‚è≠Ô∏è Terminer la question
        </button>
      }
      @if (gameStatus() === 'results') {
        <button class="btn-ctrl btn-ctrl-info" (click)="showRanking()">
          üèÜ Classement
        </button>
        <button class="btn-ctrl btn-ctrl-success" (click)="nextQuestion()">
          ‚è≠Ô∏è Question suivante
        </button>
      }
      @if (gameStatus() === 'ranking') {
        <button class="btn-ctrl btn-ctrl-success" (click)="nextQuestion()">
          ‚è≠Ô∏è Question suivante
        </button>
      }
      @if (gameStatus() === 'ended') {
        <button class="btn-ctrl btn-ctrl-info" (click)="endGame()">
          üìä R√©sultats d√©taill√©s
        </button>
      }
    </div>
    <div class="controls-right">
      <button class="btn-ctrl btn-ctrl-danger" (click)="endGame()">
        ‚èπÔ∏è Terminer
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- MODALE BUZZER                           -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  @if (showBuzzModal() && buzzWinner(); as winner) {
    <div class="buzz-modal-overlay">
      <div class="buzz-modal">
        <div class="buzz-modal-icon">üî¥</div>
        <h2 class="buzz-modal-title">{{ winner.playerName }} r√©pond !</h2>
        <p class="buzz-modal-time">
          Temps : <strong>{{ (winner.responseTime / 1000) | number:'1.2-2' }}s</strong>
        </p>
        <!-- üìå Rappel de la r√©ponse attendue dans la modale -->
        @if (currentQuestion()?.expectedAnswer) {
          <div class="expected-answer-hint">
            üìå R√©ponse attendue : <strong>{{ currentQuestion()!.expectedAnswer }}</strong>
          </div>
        }
        <div class="buzz-modal-actions">
          <button class="btn-ctrl btn-ctrl-success btn-ctrl-lg" (click)="confirmBuzzCorrect()">
            ‚úÖ Bonne r√©ponse
          </button>
          <button class="btn-ctrl btn-ctrl-danger btn-ctrl-lg" (click)="reopenBuzzer()">
            üîÑ Redonner la main
          </button>
        </div>
        <div class="buzz-modal-timer">
          ‚è∏Ô∏è Chrono en pause ‚Äî {{ timeRemaining() }}s restantes
        </div>
      </div>
    </div>
  }
</div>